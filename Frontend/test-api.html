<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API è¿æ¥æµ‹è¯• - SNC è€ƒå‹¤ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            padding: 40px 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--info-color);
            border-radius: var(--radius);
        }
        .test-section h3 {
            margin-top: 0;
            color: var(--info-color);
            margin-bottom: 15px;
        }
        .result-box {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: var(--radius);
            font-family: 'Consolas', monospace;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #333;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-ok { color: var(--success-color); font-weight: bold; }
        .status-err { color: var(--danger-color); font-weight: bold; }
        .config-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .config-row input {
            flex: 1;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
            ğŸ› ï¸ API è¿æ¥æµ‹è¯•
        </h1>
        
        <div class="info-box">
            <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•å‰ç«¯ä¸åç«¯çš„è¿æ¥çŠ¶æ€ï¼Œä»¥åŠéªŒè¯ API åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚</p>
            <p>å½“å‰ API åœ°å€: <strong id="apiUrlDisplay">è¯»å–ä¸­...</strong></p>
        </div>

        <div class="test-section">
            <h3>1. åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <p>æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿ä»¥åŠ API åŸºç¡€è·¯å¾„æ˜¯å¦å¯è®¿é—®ã€‚</p>
            <div style="margin-top: 15px;">
                <button id="pingBtn" class="btn btn-primary">Ping æœåŠ¡å™¨</button>
                <button id="checkHealthBtn" class="btn btn-info">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
            </div>
            <div id="pingResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. ç™»å½•æµ‹è¯•</h3>
            <p>æµ‹è¯•ç”¨æˆ·è®¤è¯åŠŸèƒ½ã€‚</p>
            <div class="config-row">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
                <input type="password" id="password" placeholder="å¯†ç " value="123456">
            </div>
            <button id="loginBtn" class="btn btn-success">å°è¯•ç™»å½•</button>
            <div id="loginResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æ•°æ®è·å–æµ‹è¯• (éœ€è¦å…ˆç™»å½•)</h3>
            <p>æµ‹è¯•å—ä¿æŠ¤çš„ API æ¥å£ã€‚</p>
            <button id="getTablesBtn" class="btn btn-secondary" disabled>è·å–ç­¾åˆ°è¡¨åˆ—è¡¨</button>
            <button id="getUsersBtn" class="btn btn-secondary" disabled>è·å–ç”¨æˆ·åˆ—è¡¨ (ä»…ç®¡ç†å‘˜)</button>
            <div id="dataResult" class="result-box" style="display:none;"></div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <a href="index.html" class="btn btn-secondary">è¿”å›ç™»å½•é¡µ</a>
            <a href="dashboard.html" class="btn btn-primary">å‰å¾€æ§åˆ¶å°</a>
        </div>
    </div>

    <script src="js/api.js" type="module"></script>
    <script type="module">
        import { api } from './js/api.js';

        // æ˜¾ç¤º API åœ°å€
        document.getElementById('apiUrlDisplay').textContent = api.baseURL;

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç»“æœ
        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const status = isError ? '[ERROR]' : '[SUCCESS]';
            const content = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            
            el.innerHTML = `<span class="${isError ? 'status-err' : 'status-ok'}">${timestamp} ${status}</span>\n${content}`;
        }

        // 1. Ping æµ‹è¯•
        document.getElementById('pingBtn').addEventListener('click', async () => {
            try {
                const start = Date.now();
                // å°è¯•è¯·æ±‚ä¸€ä¸ªç®€å•çš„ç«¯ç‚¹ï¼Œæˆ–è€…åªæ˜¯æ ¹è·¯å¾„
                // ç”±äºæ²¡æœ‰ä¸“é—¨çš„ ping æ¥å£ï¼Œæˆ‘ä»¬å°è¯•è¯·æ±‚ health æˆ–è€…åªæ˜¯ fetch base url
                const response = await fetch(api.baseURL + '/auth/check', { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const end = Date.now();
                
                // 401 ä¹Ÿæ˜¯é€šçš„ï¼Œåªæ˜¯æ²¡æƒé™ï¼Œè¯´æ˜æœåŠ¡å™¨åœ¨
                if (response.ok || response.status === 401) {
                    showResult('pingResult', `è¿æ¥æˆåŠŸ! å»¶è¿Ÿ: ${end - start}ms\nçŠ¶æ€ç : ${response.status}`);
                } else {
                    showResult('pingResult', `æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                showResult('pingResult', `è¿æ¥å¤±è´¥: ${error.message}\nè¯·æ£€æŸ¥:\n1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨\n2. API åœ°å€é…ç½®æ˜¯å¦æ­£ç¡®\n3. æ˜¯å¦å­˜åœ¨è·¨åŸŸé—®é¢˜`, true);
            }
        });

        document.getElementById('checkHealthBtn').addEventListener('click', async () => {
            // å‡è®¾æœ‰ä¸€ä¸ª health æ¥å£ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¿™ä¸ªæµ‹è¯•å¯èƒ½ä¼šå¤±è´¥
            showResult('pingResult', 'æ­£åœ¨æ£€æŸ¥...');
            try {
                // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…ä¸Šå¯èƒ½æ²¡æœ‰ health æ¥å£
                const response = await fetch(api.baseURL.replace('/api', '') + '/');
                if (response.ok) {
                    showResult('pingResult', 'åç«¯æœåŠ¡å™¨æ ¹è·¯å¾„å¯è®¿é—®');
                } else {
                    showResult('pingResult', `æ ¹è·¯å¾„è¿”å›: ${response.status}`, true);
                }
            } catch (e) {
                showResult('pingResult', `æ£€æŸ¥å¤±è´¥: ${e.message}`, true);
            }
        });

        // 2. ç™»å½•æµ‹è¯•
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                const result = await api.login(username, password);
                showResult('loginResult', result);
                
                // å¯ç”¨åç»­æŒ‰é’®
                document.getElementById('getTablesBtn').disabled = false;
                document.getElementById('getUsersBtn').disabled = false;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                document.getElementById('getTablesBtn').className = 'btn btn-info';
                document.getElementById('getUsersBtn').className = 'btn btn-warning';
            } catch (error) {
                showResult('loginResult', error.message || error, true);
            }
        });

        // 3. æ•°æ®æµ‹è¯•
        document.getElementById('getTablesBtn').addEventListener('click', async () => {
            try {
                const result = await api.getTables();
                showResult('dataResult', result);
            } catch (error) {
                showResult('dataResult', error.message || error, true);
            }
        });

        document.getElementById('getUsersBtn').addEventListener('click', async () => {
            try {
                const result = await api.getUsers();
                showResult('dataResult', result);
            } catch (error) {
                showResult('dataResult', error.message || error, true);
            }
        });
    </script>
</body>
</html>
