version: "3.9"

services:
  # ==================== MongoDB æ•°æ®åº“ ====================
  mongodb:
    image: mongo:7.0
    container_name: snc-attendance-mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      # ğŸ”’ ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹æ­¤å¯†ç 
      MONGO_INITDB_ROOT_PASSWORD: snc_attendance_2025
      MONGO_INITDB_DATABASE: attendance
    volumes:
      - mongodb_data:/data/db
    ports:
      # ğŸŒ å¦‚éœ€å¤–éƒ¨è®¿é—®,æ”¹ä¸º "27017:27017" (ä¸æ¨è)
      - "127.0.0.1:27017:27017"
    networks:
      - attendance-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 30s
      retries: 15
      start_period: 50s

  # ==================== Node.js åç«¯æœåŠ¡ ====================
  backend:
    image: kmtcn/snc-attendance-backend:latest
    container_name: snc-attendance-backend
    restart: always
    environment:
      NODE_ENV: production
      # ğŸ”§ åç«¯ç«¯å£(é»˜è®¤ 10234)
      PORT: 10234
      # ğŸ”’ æ³¨æ„:æ­¤å¤„å¯†ç éœ€ä¸ä¸Šæ–¹ MongoDB å¯†ç ä¸€è‡´
      MONGODB_URI: mongodb://admin:snc_attendance_2025@mongodb:27017/attendance?authSource=admin
      # ğŸ”’ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹æ­¤ JWT å¯†é’¥(ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²)
      JWT_SECRET: snc_attendance_jwt_secret_key_2025_change_in_production
      # â° Token æœ‰æ•ˆæœŸ(é»˜è®¤ 7 å¤©)
      JWT_EXPIRES_IN: 7d
      # ğŸŒ è·¨åŸŸé…ç½®(å¦‚å‰ç«¯ç‹¬ç«‹åŸŸå,æ”¹ä¸ºå…·ä½“åŸŸå)
      CORS_ORIGIN: "*"
    ports:
      # ğŸ”§ å¦‚éœ€ä¿®æ”¹ç«¯å£,æ ¼å¼: "å¤–éƒ¨ç«¯å£:10234",å¦‚ "20234:10234"
      - "127.0.0.1:10234:10234"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - attendance-network
    volumes:
      - backend_logs:/app/logs

  # ==================== å‰ç«¯æœåŠ¡ ====================
  frontend:
    image: kmtcn/snc-attendance-frontend:latest
    container_name: snc-attendance-frontend
    restart: always
    ports:
      # ğŸ”§ å¦‚éœ€ä¿®æ”¹ç«¯å£,æ ¼å¼: "å¤–éƒ¨ç«¯å£:80",å¦‚ "18080:80"
      - "127.0.0.1:8080:80"
    networks:
      - attendance-network
    depends_on:
      - backend

# ==================== ç½‘ç»œé…ç½® ====================
networks:
  attendance-network:
    driver: bridge

# ==================== æ•°æ®æŒä¹…åŒ– ====================
volumes:
  mongodb_data:
    driver: local
  backend_logs:
    driver: local

# ==================== ä½¿ç”¨è¯´æ˜ ====================
# 
# 1ï¸âƒ£  å¯åŠ¨æœåŠ¡:
#     docker-compose up -d
# 
# 2ï¸âƒ£  æŸ¥çœ‹æ—¥å¿—:
#     docker-compose logs -f
# 
# 3ï¸âƒ£  åœæ­¢æœåŠ¡:
#     docker-compose down
# 
# 4ï¸âƒ£  æ›´æ–°æœåŠ¡:
#     docker-compose pull && docker-compose up -d
# 
# 5ï¸âƒ£  å®Œå…¨æ¸…ç†(å«æ•°æ®):
#     docker-compose down -v
# 
# ğŸ“ æœåŠ¡åœ°å€:
#     å‰ç«¯: http://localhost:8080
#     åç«¯: http://localhost:10234
# 
# ğŸ”’ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•:
#     â˜‘ ä¿®æ”¹ MongoDB å¯†ç 
#     â˜‘ ä¿®æ”¹ JWT_SECRET
#     â˜‘ é…ç½® CORS_ORIGIN
#     â˜‘ è€ƒè™‘ä½¿ç”¨åå‘ä»£ç†(Nginx/Caddy)
#     â˜‘ å¯ç”¨ HTTPS
