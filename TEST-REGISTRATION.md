# 测试注册限制功能

本文档说明如何测试新的注册限制功能。

## 功能说明

- ✅ **首次使用**：可以注册第一个超级管理员
- ❌ **有用户后**：完全禁止注册，只能由超级管理员添加用户

## 测试步骤

### 测试场景1：首次使用（无用户）

1. **清空用户数据**
   ```powershell
   cd Backend
   node clear-users.js
   ```

2. **确认清空成功**
   ```powershell
   node check-users.js
   ```
   应显示：用户总数: 0

3. **访问登录页面**
   - 打开浏览器，访问 `Frontend/index.html`
   - 应该看到：
     - ✅ 自动显示注册表单
     - ✅ 显示"🎉 欢迎首次使用！"
     - ✅ 提示"第一个注册的用户将自动成为超级管理员"
     - ✅ 没有"切换到登录"按钮

4. **注册第一个用户**
   - 输入用户名：`admin`
   - 输入密码：`123456`（至少6个字符）
   - 确认密码：`123456`
   - 点击"创建超级管理员账户"

5. **验证注册成功**
   - 应该自动登录
   - 跳转到管理面板
   - 左侧导航栏显示"👥 用户管理"菜单

### 测试场景2：已有用户（禁止注册）

1. **确保数据库中有用户**
   ```powershell
   cd Backend
   node check-users.js
   ```
   应显示：用户总数: 1 或更多

2. **退出登录**
   - 在管理面板点击"退出登录"

3. **再次访问登录页面**
   - 应该看到：
     - ✅ 只显示登录表单
     - ✅ **没有注册按钮**
     - ✅ **没有"点击注册"链接**
     - ✅ 无法切换到注册表单

4. **尝试直接调用注册API（后端保护测试）**
   ```powershell
   # 使用 PowerShell 测试
   $body = @{
       username = "testuser"
       password = "123456"
   } | ConvertTo-Json

   Invoke-RestMethod -Uri "http://localhost:10234/api/auth/register" `
       -Method POST `
       -ContentType "application/json" `
       -Body $body
   ```
   
   应该返回错误：
   ```json
   {
     "success": false,
     "message": "系统已完成初始化设置，新用户请联系超级管理员在用户管理中添加"
   }
   ```

### 测试场景3：通过用户管理添加用户

1. **超级管理员登录**
   - 使用之前创建的超级管理员账户登录

2. **进入用户管理**
   - 点击左侧"👥 用户管理"

3. **添加新用户**
   - 点击"➕ 添加用户"
   - 填写信息：
     - 用户名：`user1`
     - 密码：`123456`
     - 角色：选择"管理员"或"普通用户"
   - 点击"添加"

4. **验证用户创建成功**
   - 用户列表中显示新用户
   - 退出登录
   - 使用新用户账户登录
   - 登录成功

## 预期结果对比

| 场景 | 注册按钮 | 注册功能 | 后端API | 正确性 |
|------|---------|---------|---------|--------|
| 首次使用（无用户） | ❌ 无按钮（直接显示注册表单） | ✅ 可注册 | ✅ 允许 | ✅ 正确 |
| 已有用户 | ❌ 完全隐藏 | ❌ 不可用 | ❌ 拒绝 | ✅ 正确 |
| 用户管理添加 | N/A | ✅ 可添加 | ✅ 允许 | ✅ 正确 |

## 安全检查清单

- [x] 首次使用时可以注册超级管理员
- [x] 注册成功后，登录页面不再显示注册功能
- [x] 直接调用注册API被拒绝（后端保护）
- [x] 前端完全隐藏注册入口（UI保护）
- [x] 超级管理员可以在用户管理中添加用户
- [x] 新添加的用户可以正常登录
- [x] 非超级管理员看不到用户管理菜单

## 常见问题

### Q: 如何重新测试首次注册功能？
A: 运行 `node clear-users.js` 清空所有用户，然后重新访问登录页面。

### Q: 误删了超级管理员怎么办？
A: 清空用户数据，重新注册第一个超级管理员。

### Q: 普通用户能否看到用户管理？
A: 不能。只有超级管理员（`isSuperAdmin: true`）才能看到用户管理菜单。

### Q: 如何验证注册API确实被禁用？
A: 使用上面的 PowerShell 命令直接调用 API，应该返回 403 错误。

## 开发者说明

### 前端保护
- `Frontend/js/login.js` - 检查系统状态，隐藏注册UI
- 基于 `/api/auth/check-setup` 的返回值决定显示内容

### 后端保护
- `Backend/src/routes/auth.js` - `/register` 端点检查用户数量
- 如果 `userCount > 0`，返回 403 错误
- 双重保护：前端UI + 后端API

### 数据库保护
- 用户只能通过两种方式创建：
  1. 首次注册（数据库空时）
  2. 超级管理员通过 `/api/users` 端点添加
